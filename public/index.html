<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Update Variant Location</title>

  <!-- Shopify Polaris CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@11.0.0/dist/styles.css" />
  <!-- HTML5 QR/Barcode scanner library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <!-- Shopify App Bridge -->
  <script src="https://unpkg.com/@shopify/app-bridge@3"></script>

  <style>
    body {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', Roboto, 'Segoe UI', 'Helvetica Neue', sans-serif;
    }
    .field { margin-bottom: 1rem; }
    .scanner { margin-top: 0.5rem; display: none; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Update Product Location</h1>

  <div class="field">
    <label>Product Barcode:</label>
    <input id="barcode" placeholder="Scan or enter barcode" />
    <button id="scanBarcodeBtn">Scan Barcode</button>
    <div id="barcodeScanner" class="scanner"></div>
  </div>

  <div class="field">
    <label>Location:</label>
    <input id="location" placeholder="Scan or enter location" />
    <button id="scanLocationBtn">Scan Location</button>
    <div id="locationScanner" class="scanner"></div>
  </div>

  <button id="updateBtn">Update Location</button>

  <div id="status"></div>

  <script>
    const barcodeInput = document.getElementById('barcode');
    const locationInput = document.getElementById('location');
    const statusDiv = document.getElementById('status');

    function toggleScanner(type) {
      const scannerDiv = document.getElementById(type + 'Scanner');
      const inputField = type === 'barcode' ? barcodeInput : locationInput;

      if (scannerDiv.style.display === 'block') {
        scannerDiv.innerHTML = '';
        scannerDiv.style.display = 'none';
        return;
      }

      scannerDiv.style.display = 'block';
      const html5QrCode = new Html5Qrcode(scannerDiv.id);

      html5QrCode.start(
        { facingMode: 'environment' },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          formatsToSupport: [
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.QR_CODE
          ]
        },
        (decodedText) => {
          inputField.value = decodedText;
          html5QrCode.stop().catch(console.error);
          scannerDiv.style.display = 'none';
        }
      ).catch((err) => {
        console.error(err);
        statusDiv.textContent = 'Could not access the camera. Check permissions.';
        scannerDiv.style.display = 'none';
      });
    }

    document.getElementById('scanBarcodeBtn').onclick = () => toggleScanner('barcode');
    document.getElementById('scanLocationBtn').onclick = () => toggleScanner('location');

    document.getElementById('updateBtn').onclick = async () => {
      const barcode = barcodeInput.value.trim();
      const location = locationInput.value.trim();

      if (!barcode || !location) {
        statusDiv.textContent = 'Please fill both fields.';
        return;
      }

      statusDiv.textContent = 'Updating...';

      try {
        const lookupResp = await fetch('/lookup-variant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ barcode })
        });

        if (!lookupResp.ok) throw new Error('Variant lookup failed');

        const { variant } = await lookupResp.json();

        const updateResp = await fetch('/update-location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ variantId: variant.id, locationValue: location })
        });

        if (!updateResp.ok) throw new Error('Location update failed');

        statusDiv.textContent = 'Location updated successfully!';
        barcodeInput.value = '';
        locationInput.value = '';
      } catch (err) {
        console.error(err);
        statusDiv.textContent = err.message;
      }
    };
  </script>
</body>
</html>
