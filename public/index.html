<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Variant Location Updater</title>

    <!-- Polaris CSS (optional) -->
    <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@11.0.0/dist/styles.css" />
    <!-- html5‑qrcode for camera -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <!-- App Bridge (iframe redirect) -->
    <script src="https://unpkg.com/@shopify/app-bridge@3"></script>

    <style>
      body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;max-width:640px;margin:0 auto;padding:24px}
      .field{margin-bottom:1rem}
      .scanner{display:none;margin-top:.5rem}
      #status{margin-top:1rem;font-weight:600}
      #productInfo{margin-top:.5rem;color:#333;font-style:italic}
      button{background:#008060;color:#fff;border:none;padding:.6rem 1.2rem;border-radius:4px;cursor:pointer}
      button:disabled{background:#bbb}
    </style>
  </head>
  <body>
    <h1>Update Product Location</h1>

    <!-- barcode -->
    <div class="field">
      <label for="barcode">Product Barcode</label>
      <input id="barcode" placeholder="Scan or type barcode" />
      <button id="scanBarcodeBtn" type="button">Scan</button>
      <div id="barcodeScanner" class="scanner"></div>
    </div>

    <!-- product title -->
    <div id="productInfo"></div>

    <!-- location -->
    <div class="field">
      <label for="location">Location</label>
      <input id="location" placeholder="Scan or type location" />
      <button id="scanLocationBtn" type="button">Scan</button>
      <div id="locationScanner" class="scanner"></div>
    </div>

    <button id="updateBtn" disabled>Update Location</button>
    <div id="status"></div>

    <script>
      /****** App Bridge (optional) ******/
      const hostParam = new URLSearchParams(window.location.search).get('host');
      const PUBLIC_KEY = 'YOUR_APP_API_KEY'; // replace
      if (window['app-bridge'] && hostParam && !PUBLIC_KEY.includes('YOUR_APP_API_KEY')) {
        const createApp = window['app-bridge'].default || window['app-bridge'].createApp;
        createApp({ apiKey: PUBLIC_KEY, host: hostParam, forceRedirect: true });
      }

      /****** DOM refs ******/
      const barcodeInput   = document.getElementById('barcode');
      const locationInput  = document.getElementById('location');
      const productInfoDiv = document.getElementById('productInfo');
      const statusDiv      = document.getElementById('status');
      const updateBtn      = document.getElementById('updateBtn');
      let cachedVariantId  = null;

      const setStatus = (msg, err=false)=>{statusDiv.textContent=msg;statusDiv.style.color=err?'#b00020':'#008060'};
      const checkReady = ()=>{updateBtn.disabled = !(barcodeInput.value.trim() && locationInput.value.trim());};
      barcodeInput.addEventListener('input',()=>{cachedVariantId=null;productInfoDiv.textContent='';checkReady();});
      locationInput.addEventListener('input',checkReady);

      /****** Scanner helper ******/
      function launchScanner(kind){
        const div=document.getElementById(`${kind}Scanner`);
        const target= kind==='barcode'?barcodeInput:locationInput;
        if(div.style.display==='block'){div.innerHTML='';div.style.display='none';return;}
        div.innerHTML='';div.style.display='block';
        const qr=new Html5Qrcode(div.id);
        qr.start({facingMode:'environment'},{fps:10,qrbox:{width:250,height:250},formatsToSupport:[Html5QrcodeSupportedFormats.UPC_A,Html5QrcodeSupportedFormats.EAN_13,Html5QrcodeSupportedFormats.CODE_128,Html5QrcodeSupportedFormats.QR_CODE]},
          txt=>{target.value=txt;if(kind==='barcode'){cachedVariantId=null;productInfoDiv.textContent='';};checkReady();qr.stop();div.style.display='none';},
          ()=>{})
          .catch(e=>{console.error(e);setStatus('Cannot access camera',true);div.style.display='none';});
      }
      document.getElementById('scanBarcodeBtn').onclick=()=>launchScanner('barcode');
      document.getElementById('scanLocationBtn').onclick=()=>launchScanner('location');

      /****** Variant lookup (function) ******/
      async function lookupVariant(barcode){
        setStatus('Looking up variant…');
        const res = await fetch('/lookup-variant',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({barcode})});
        if(!res.ok) throw new Error('Variant lookup failed');
        const data = await res.json();
        cachedVariantId = data.variant.id;
        productInfoDiv.textContent = data.productTitle?`Product: ${data.productTitle}`:`Variant ID: ${cachedVariantId}`;
        setStatus('Variant found ✓');
      }

      /****** Trigger lookup when leaving barcode field ******/
      barcodeInput.addEventListener('blur',async ()=>{
        const code = barcodeInput.value.trim();
        if(!code) return;
        try{await lookupVariant(code);}catch(e){cachedVariantId=null;productInfoDiv.textContent='';setStatus(e.message,true);}finally{checkReady();}
      });

      /****** Update button ******/
      updateBtn.onclick = async ()=>{
        const code = barcodeInput.value.trim();
        const loc  = locationInput.value.trim();
        if(!code||!loc) return;
        try{
          if(!cachedVariantId){ await lookupVariant(code); }
          if(!cachedVariantId) throw new Error('Variant not found');
          setStatus('Updating location…');
          const res = await fetch('/update-location',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({variantId:cachedVariantId,locationValue:loc})});
          if(!res.ok) throw new Error('Location update failed');
          setStatus('Location updated!');
          barcodeInput.value='';locationInput.value='';productInfoDiv.textContent='';cachedVariantId=null;checkReady();
        }catch(e){setStatus(e.message,true);}  
      };

    </script>
  </body>
</html>
