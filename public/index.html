<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Update Variant Location</title>

    <!-- Optional Polaris look-&-feel -->
    <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@11.0.0/dist/styles.css"/>

    <!-- html5-qrcode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <!-- App Bridge if embedded -->
    <script src="https://unpkg.com/@shopify/app-bridge@3"></script>

    <style>
      body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;max-width:640px;margin:0 auto;padding:24px}
      .field{margin-bottom:1rem}
      button{background:#008060;color:#fff;border:none;padding:.55rem 1.1rem;border-radius:4px;cursor:pointer}
      button:disabled{background:#bbb}
      .scanner{display:none;margin-top:.5rem}
      #status{margin-top:1rem;font-weight:600}
      #status.error{color:#b00020} #status.ok{color:#008060}
      #productInfo,#currentLoc{margin-top:.4rem;font-style:italic;color:#333}
    </style>
  </head>
  <body>
    <h1>Update Product Location</h1>

    <!-- 1️⃣  Barcode -->
    <div class="field">
      <label>Product Barcode</label>
      <input id="barcode" placeholder="Scan or type barcode" autocomplete="off"/>
      <button id="scanBarcode">📷</button>
      <button id="lookupBtn">Search</button>
      <div id="barcodeScanner" class="scanner"></div>
    </div>

    <!-- Variant selector (appears only if >1) -->
    <div class="field" id="variantField" style="display:none;">
      <label>Choose Variant</label>
      <select id="variantSelect"></select>
    </div>

    <div id="productInfo"></div>
    <div id="currentLoc"></div>

    <!-- 2️⃣  Location -->
    <div class="field">
      <label>New Location</label>
      <input id="location" placeholder="Scan or type location" autocomplete="off"/>
      <button id="scanLocation">📷</button>
      <div id="locationScanner" class="scanner"></div>
    </div>

    <!-- 3️⃣  Save -->
    <button id="saveBtn" disabled>Save Location</button>
    <div id="status"></div>

    <script>
      /* ----------  App Bridge bootstrap (optional) ---------- */
      const host = new URLSearchParams(location.search).get("host");
      const KEY  = "YOUR_APP_API_KEY";        // <-- replace if embedded
      if (window["app-bridge"] && host && !KEY.includes("YOUR_APP_API_KEY")) {
        (window["app-bridge"].default||window["app-bridge"].createApp)({ apiKey: KEY, host, forceRedirect:true });
      }

      /* ----------  DOM helpers ---------- */
      const $  = id => document.getElementById(id);
      const qs = (parent,sel)=>parent.querySelector(sel);

      const barcodeInp = $("barcode");
      const locInp     = $("location");
      const variantSel = $("variantSelect");
      const variantBox = $("variantField");
      const statusBox  = $("status");
      const saveBtn    = $("saveBtn");

      let variants = [];          // array of {id,title,currentLocation}
      const chosenVariant = ()=> variants.length===1 ? variants[0] : variants[variantSel.selectedIndex];

      const setStatus=(msg,ok)=>{statusBox.textContent=msg;statusBox.className=ok?"ok":"error";};
      const ready   =()=>{saveBtn.disabled = !(chosenVariant() && locInp.value.trim());};

      barcodeInp.addEventListener("input",()=>{variants=[];variantBox.style.display="none";$("productInfo").textContent="";$("currentLoc").textContent="";ready();});
      locInp    .addEventListener("input",ready);
      variantSel.addEventListener("change",()=>{showCurrent();ready();});

      /* ----------  Camera scan ---------- */
      function startScan(kind){
        const box = $(kind+"Scanner");
        const dest= kind==="barcode"? barcodeInp : locInp;
        if(box.style.display==="block"){box.innerHTML="";box.style.display="none";return;}
        box.innerHTML="";box.style.display="block";
        const qr=new Html5Qrcode(box.id);
        qr.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},
          txt=>{dest.value=txt; if(kind==="barcode"){variants=[];variantBox.style.display="none";} ready(); qr.stop();box.style.display="none";})
          .catch(()=>{setStatus("Camera denied",false);box.style.display="none";});
      }
      $("scanBarcode") .onclick =()=>startScan("barcode");
      $("scanLocation").onclick =()=>startScan("location");

      /* ----------  Lookup variant ---------- */
      $("lookupBtn").onclick = async ()=>{
        const code = barcodeInp.value.trim();
        if(!code) return setStatus("Enter barcode",false);
        setStatus("Searching…",true);
        try{
          const res = await fetch("/lookup-variant",{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify({ barcode:code })});
          if(!res.ok) throw new Error("No match");
          const data = await res.json();
          variants = data.variants || (data.variant ? [{ id:data.variant.id, title:data.productTitle||data.variant.id, currentLocation:data.currentLocation||"" }] : []);
          if(!variants.length) throw new Error("No variant matches");

          if(variants.length===1){ variantBox.style.display="none"; }
          else{
            variantBox.style.display="block";
            variantSel.innerHTML = variants.map(v=>`<option>${v.title}</option>`).join("");
          }
          qs(document,"#productInfo").textContent = variants.length===1 ? `Product: ${variants[0].title}` : `Matches found: ${variants.length}`;
          showCurrent();
          setStatus("Variant ready ✓",true);
          ready();
        }catch(err){ setStatus(err.message||"Lookup failed",false); }
      };

      function showCurrent(){
        const v = chosenVariant();
        $("currentLoc").textContent = v && v.currentLocation ? `Current location: ${v.currentLocation}` : "";
      }

      /* ----------  Save location ---------- */
      saveBtn.onclick = async ()=>{
        const v   = chosenVariant();
        const loc = locInp.value.trim();
        if(!v || !loc) return;
        setStatus("Saving…",true);
        try{
          const r = await fetch("/update-location",{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify({ variantId:v.id, locationValue:loc })});
          if(!r.ok) throw new Error("Save failed");
          v.currentLocation = loc; showCurrent();
          locInp.value=""; saveBtn.disabled=true;
          setStatus("Location updated!",true);
        }catch(err){ setStatus(err.message,false); }
      };
    </script>
  </body>
</html>
